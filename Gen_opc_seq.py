"""
We disssemble malware and benign Windows PE binaries using Radare2 disassembler.
r2pipe has been used to script Radare2, for disassembly and generation of 
instruction codes (opcodes) sequences in csv.

"""
import os
import r2pipe
import pandas as pd

# for each executable in the files directoty, generate opcodes and store in a file
for sample in os.listdir('path to directory containg dataset samples'):
    #generating opcodes....
    r=r2pipe.open('path to directory containg dataset samples'+ sample) #open binary file
    r.cmd('aaa')
    r.cmd('pif @@f ~[0] > opcode.txt')
    r.quit()
    # read the generated opcode of a sample line by line
    with open ('opcode.txt','r') as fl:
         content=fl.readlines()
         fl.close()
    # remove empty space before and after each opcode and add to a list
    opc=[cont.strip() for cont in content]
    opc=' '.join(opc)   # make a sequence of opcodes from the list
    
    #finally append sample's generated opcodes to the final opcode compiled file
    with open('Dataset_opcode.txt','a') as fl:
         fl.write(opc + '\n')
         fl.close()


# preparing labels
with open ('Dataset_opcode_label.txt','r') as lb:
    lbs=lb.readlines()

labels=[lb.strip() for lb in lbs]
    
# myopcodes.txt file contains generated opcodes from many samples
with open('Dataset_opcode.txt','r') as opc:
    opcodes=opc.readlines()           # read opcodes for each sample line by line


code=[opc.strip() for opc in opcodes]     # create a list of opcodes for samples


# Generate opcode sequence csv
dataframe=pd.DataFrame({'opcodes':code,'labels':labels})    
dataframe.to_csv('opcode.csv',index=False)

# Shuffle csv feature set 
df=pd.read_csv('opcode.csv')
shuffle_df=df.sample(frac=1, random_state=42)
shuffle_df.to_csv('opcode-1.csv', index=False)